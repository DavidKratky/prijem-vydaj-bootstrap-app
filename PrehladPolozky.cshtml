@{
    Layout = "~/_SiteLayout.cshtml";

    var db = Database.Open("db");
    var id = UrlData[0];

    if (id == null || id.IsEmpty())
    {
        Response.Redirect("Home.cshtml");
    }

    var polozka = db.QuerySingle(@"SELECT * FROM prijem_vydaj p 
                        inner join kategoria k on p.kategoria_id = k.id 
                        where p.id = @0", id);

    var fotkyPolozky = db.Query(@"SELECT f.*, p.id as idcko FROM Fotky f 
                        INNER JOIN prijem_vydaj p ON f.PolozkaId = p.id where p.id = @0", id);

    var dokumentyPolozky = db.Query(@"SELECT d.*, p.id as idcko FROM Dokumenty d 
                        INNER JOIN prijem_vydaj p ON d.IdPolozky = p.id where p.id = @0", id);

    WebImage photo = null;
    var nazov = "";
    var path = "";
    var pathThmubs = "";
    var cestaDoc = "";

    if (IsPost)
    {
        var typFormularu = Request.Form["typFormularu"];

        if("ulozFotografiu".Equals(typFormularu)){
            photo = WebImage.GetImageFromRequest("foto");
            if (photo != null)
            {
                nazov = DateTime.Now.Year + "_" + Guid.NewGuid().ToString() + "_" + Path.GetFileName(photo.FileName);
                path = @"images\" + nazov;

                photo.Save(@"~\" + path);

                pathThmubs = @"images\thumbs\" + nazov;
                photo.Resize(width: 200, height: 200, preserveAspectRatio: true, preventEnlarge: true)
                    .Crop(1, 1);
                photo.Save(@"~\" + pathThmubs);

                db.Execute(@"INSERT INTO [Fotky]
           ([Path]
           ,[PathThumbs]
           ,[PolozkaId], [Popis]) VALUES (@0,@1,@2,@3)", path, pathThmubs, id, Request.Form["text"]);
            }
        }

        if ("ulozDokument".Equals(typFormularu))
        {
            var pocet = Request.Files.Count;
            var popisok = "";
            for(int i = 0; i<pocet; i++)
            {
                var nazovDoc = "";
                var subor = Request.Files[i];
                if(subor.ContentLength > 0)
                {
                    nazovDoc = Path.GetFileName(subor.FileName);
                    var pathDoc = Server.MapPath("~/files/" + nazovDoc);
                    cestaDoc = "~/files/" + nazovDoc;
                    subor.SaveAs(pathDoc);
                }

                popisok = Request.Form["text"];
                db.Execute(@"INSERT INTO Dokumenty (Nazov, Popisok, IdPolozky)
                            VALUES (@0,@1,@2)", nazovDoc, popisok, id);
            }

        }



        Response.Redirect("~/PrehladPolozky/" + id);
    }
}

<a href="~/files/@("tricko.jpg"))"></a>
<div class="jumbotron jumbotron-fluid">
    <div class="container">
        <h1 class="display-4">@polozka.nazov_polozky</h1>
        <p class="lead">Dňa @(polozka.datum.ToString("dd.MM.yyyy")). @polozka.popis </p>
        <h4 class="text-danger">@polozka.cena euro <span class="text-muted">@polozka.kategoria</span></h4>
    </div>
</div>

<div class="container">
    <div class="row">
        <div class="col-4">
            <div class="list-group" id="list-tab" role="tablist">

                @{
                    var isFirst = true;
                }
                @foreach (var f in fotkyPolozky)
                {
                    <a class="list-group-item list-group-item-action @(isFirst?"active":"") " id="list-foto-list@(f.id)" data-toggle="list" href="#list-foto@(f.id)" role="tab" aria-controls="foto">
                        @f.Popis
                    </a>
                    if (isFirst)
                    {
                        isFirst = false;
                    }
                }

                @foreach (var d in dokumentyPolozky)
                {
                    <a class="list-group-item list-group-item-action @(isFirst?"active":"") " id="list-foto-list@(d.id)" data-toggle="list" href="#list-foto@(d.id)" role="tab" aria-controls="foto">
                        @d.Nazov
                    </a>
                    if (isFirst)
                    {
                        isFirst = false;
                    }
                }

            </div>
            <div class="btn-group mt-5" role="group" aria-label="Pridať foto - dokument">
                <button type="button" class="btn btn-outline-primary btn-lg" data-toggle="modal" data-target="#addFoto">Pridať foto</button>
                <button type="button" class="btn btn-outline-primary btn-lg" data-toggle="modal" data-target="#addDoc">Pridať dokument</button>
            </div>
        </div>
        <div class="col-8">
            <div class="tab-content" id="nav-tabContent">
                @{
                    var isFirst2 = true;
                }
                @foreach (var f in fotkyPolozky)
                {
                    <div class="tab-pane fade @(isFirst2?"show active":"")" id="list-foto@(f.id)" role="tabpanel" aria-labelledby="list-foto-list@(f.id)">
                        <img src="../@(f.Path)" alt="tričko" class="img-fluid img-thumbnail" />
                    </div>
                    if (isFirst2)
                    {
                        isFirst2 = false;
                    }
                }

           
                @foreach (var d in dokumentyPolozky)
                {
                    <div class="tab-pane fade @(isFirst2?"show active":"")" id="list-foto@(d.id)" role="tabpanel" aria-labelledby="list-foto-list@(d.id)">
                        <p class="lead">@d.Popisok</p>
                        <a href="~/files/@(d.Nazov)">@d.Nazov</a>
                    </div>
                    if (isFirst2)
                    {
                        isFirst2 = false;
                    }
                }


                <div class="tab-pane fade" id="list-fakZadok" role="tabpanel" aria-labelledby="list-fakZadok-list">
                    <p class="lead">Toto je faktura na kupu zadna strana. Daj pozor uchovat kvoli reklamacii.</p>
                    <a href="#">faktúra predná strana</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="addFoto" tabindex="-1" role="dialog" aria-labelledby="addFotoTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title" id="addFotoTitle">Pridaj fotku</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <form method="get" enctype="multipart/form-data">
            <div class="modal-body">
                <div class="form-group">
                    <label for="foto">Fotografia</label>
                    <input type="file" class="form-control-file" id="foto" name="foto" />
                    <label for="text">Popisok</label>
                    <input type="text" class="form-control" id="text" name="text" />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Zavrieť okno</button>
                <button type="submit" class="btn btn-primary" name="typFormularu" value="ulozFotografiu">Ulož</button>
            </div>
        </form>
        </div>
    </div>
</div>

<div class="modal fade" id="addDoc" tabindex="-1" role="dialog" aria-labelledby="addDocTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addDocTitle">Pridaj dokument</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form method="post" enctype="multipart/form-data">
                <div class="modal-body">

                    <div class="form-group">
                        <label for="doc">Dokument</label>
                        <input type="file" class="form-control-file" id="doc" name="files[]" multiple="multiple"/>
                        <label for="text">Popisok</label>
                        <input type="text" class="form-control" id="text" name="text" />
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Zavrieť okno</button>
                    <button type="submit" class="btn btn-primary" name="typFormularu" value="ulozDokument">Ulož</button>
                </div>
            </form>
        </div>
    </div>
</div>



